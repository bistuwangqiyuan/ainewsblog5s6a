### CONSENSUS — AI 编程新闻网站（范围/验收/技术方案）

| 项目范围  | 细则                                                                                                                       |
| --------- | -------------------------------------------------------------------------------------------------------------------------- |
| 资讯聚合  | 每日 ≥100 条“AI 编程”相关内容，来源 ≥20 站点，去重后写入 Supabase，首页按时间排序可筛选/搜索/分页。                        |
| 社区内容  | 论坛与专家问答共享同一内容模型与表；页面两标签切换视图。支持发帖/提问、单层评论、点赞、收藏、举报、图片/视频上传。无审核。 |
| 用户系统  | Supabase Auth 邮箱+密码注册登录；个人资料、等级、积分明细与统计视图；站内信与系统通知。                                    |
| 页面内容  | 首页、论坛/问答、投稿、消息、反馈、登录/注册、个人中心、关于/隐私/服务协议/网站介绍。统一头尾、中文界面。                  |
| 安全/合规 | 环境变量管理密钥；前端仅 `PUBLIC_` 前缀；敏感词简单规则过滤；上传大小 ≤10MB；严格类型白名单。                              |

#### 验收标准（可测试）

| 编号 | 验收点                                    | 验证方法                                                                                     |
| ---- | ----------------------------------------- | -------------------------------------------------------------------------------------------- |
| A1   | 每日抓取 ≥100 条去重数据写入 `news_items` | 触发定时/手动执行抓取函数后查询 `news_items` 近 24h 计数 ≥100，且 `url` 唯一约束无冲突错误。 |
| A2   | 首页分页+搜索+筛选可用                    | 前端输入关键词、按来源/时间筛选，分页稳定返回，网络失败时显示提示而非伪造数据。              |
| A3   | 论坛/问答发布与浏览                       | 登录后可发布文本+图/视频，浏览支持分页与筛选；内容含敏感词被拦截。                           |
| A4   | 互动功能                                  | 点赞/收藏/评论/举报均能成功写入对应表，重复点赞受限，评论不可编辑/删除。                     |
| A5   | 用户上传限制                              | 超过 10MB 或非白名单格式拒绝并提示；成功上传生成可访问链接。                                 |
| A6   | 站内消息                                  | 能发送私信、接收系统通知；消息列表与未读数正确。                                             |
| A7   | 积分与等级                                | 行为触发积分流水，用户档案显示积分总额与等级；等级阈值计算正确。                             |
| A8   | AI 问答                                   | 提交问题经 `aiProxy` 调用真实厂商 API 返回；失败时显示错误提示，不降级伪造。                 |

#### 技术实现方案

| 方面       | 方案                                                                                                                                                                                                                            |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 前端       | Astro 页面，组件用 `.astro` + 原生 HTML/CSS/JS；统一 `Layout.astro`，按页面在 `src/pages/` 下新增文件；数据交互走 Supabase JS SDK 与 Netlify Functions（仅抓取与 AI 代理）。                                                    |
| 数据库     | Supabase Postgres，采用以下核心表：`news_items`, `posts`, `comments`, `likes`, `favorites`, `reports`, `messages`, `notifications`, `profiles`, `points_ledger`, `user_levels`, `attachments`。关键唯一约束：`news_items.url`。 |
| 存储       | Supabase Storage：`public-uploads`（公开）、`private-uploads`（私有）。服务器端（函数）进行容量与类型检查，前端再校验一层。                                                                                                     |
| 抓取       | Netlify Scheduled Function `crawler.js` 拉取 RSS/API，标准化映射为统一结构，按 `url` 去重后 `upsert` 到 `news_items`。                                                                                                          |
| AI 代理    | Netlify Function `aiProxy.js`，根据 `provider` 参数路由至 DeepSeek/GLM/通义/腾讯/讯飞/豆包/Minimax 等；必须使用真实密钥，失败即返回错误码与消息。                                                                               |
| 积分与等级 | 通过 `points_ledger` 记录事件积分（注册、登录、发帖、评论、被点赞等），每日/实时计算 `profiles.total_points` 与 `profiles.level`（可在 SQL 视图或函数中计算）。                                                                 |
| RLS 策略   | 读：大多开放；写：必须 `auth.uid() = user_id`；禁止评论与收藏的更新/删除；点赞幂等限制（同一资源+用户唯一）。                                                                                                                   |
