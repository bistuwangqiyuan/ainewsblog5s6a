---
import Layout from '../layouts/Layout.astro';
---

<Layout title="帖子详情">
    <section class="mb-8">
        <h1 class="mb-4 text-2xl font-semibold">帖子详情</h1>
        <article id="post" class="p-4 rounded-lg bg-black/20 mb-6"></article>
        <h2 class="mb-2 text-xl">评论</h2>
        <div id="comments" class="flex flex-col gap-3 mb-4"></div>
        <form id="cForm" class="flex gap-2">
            <input id="cInput" class="input" placeholder="写下你的评论（不可编辑/删除）" />
            <button id="cBtn" class="btn">发布</button>
        </form>
    </section>

    <script type="module">
        import { supabase } from '../utils/supabaseClient.js';

        const params = new URLSearchParams(location.search);
        const postId = params.get('id');
        const el = {
            post: document.getElementById('post'),
            comments: document.getElementById('comments'),
            cInput: document.getElementById('cInput'),
            cBtn: document.getElementById('cBtn')
        };

        async function load() {
            const { data: p, error } = await supabase.from('posts').select('*').eq('id', postId).single();
            if (error) {
                el.post.textContent = error.message;
                return;
            }
            el.post.innerHTML = `<h3 class="text-lg font-semibold mb-1">${p.title}</h3><p class="text-sm opacity-80 mb-2">${p.body}</p><p class="text-xs opacity-70">${new Date(p.created_at).toLocaleString()}</p>`;
            const { data: cs } = await supabase.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: false });
            el.comments.innerHTML = '';
            (cs || []).forEach((c) => {
                const d = document.createElement('div');
                d.className = 'p-3 rounded bg-black/10';
                d.textContent = `${c.user_id?.slice(0, 8)}：${c.content}`;
                el.comments.appendChild(d);
            });
        }

        async function addComment() {
            const user = (await supabase.auth.getUser()).data.user;
            if (!user) {
                alert('请先登录');
                return;
            }
            const t = el.cInput.value?.trim();
            if (!t || t.length < 3) {
                alert('至少 3 字');
                return;
            }
            const { error } = await supabase.from('comments').insert({ post_id: postId, user_id: user.id, content: t });
            if (error) alert(error.message);
            else {
                el.cInput.value = '';
                await load();
            }
        }

        el.cBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await addComment();
        });
        await load();
    </script>
</Layout>
