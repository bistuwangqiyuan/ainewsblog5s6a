---
import Layout from '../layouts/Layout.astro';
---

<Layout title="站内消息">
    <section class="mb-8">
        <h1 class="mb-4 text-2xl font-semibold">站内消息</h1>
        <form id="send" class="flex gap-2 mb-4">
            <input id="to" class="input" placeholder="收件人用户ID" />
            <input id="body" class="input" placeholder="消息内容" />
            <button id="sendBtn" class="btn">发送</button>
        </form>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h2 class="text-xl mb-2">私信</h2>
                <div id="list" class="flex flex-col gap-2"></div>
            </div>
            <div>
                <h2 class="text-xl mb-2">系统通知</h2>
                <div id="notices" class="flex flex-col gap-2"></div>
            </div>
        </div>
    </section>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        const supabase = createClient(import.meta.env.PUBLIC_SUPABASE_URL, import.meta.env.PUBLIC_SUPABASE_ANON_KEY);

        const el = {
            to: document.getElementById('to'),
            body: document.getElementById('body'),
            sendBtn: document.getElementById('sendBtn'),
            list: document.getElementById('list'),
            notices: document.getElementById('notices')
        };
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) {
            el.list.innerHTML = '<p>请先登录。</p>';
        }

        async function load() {
            const { data } = await supabase
                .from('messages')
                .select('*')
                .or(`receiver_id.eq.${user.id},sender_id.eq.${user.id}`)
                .order('created_at', { ascending: false })
                .limit(50);
            el.list.innerHTML = '';
            (data || []).forEach((m) => {
                const d = document.createElement('div');
                d.className = 'p-3 rounded bg-black/10';
                d.textContent = `${m.sender_id?.slice(0, 6)} -> ${m.receiver_id?.slice(0, 6)} · ${m.body}`;
                el.list.appendChild(d);
            });

            const { data: ns } = await supabase.from('notifications').select('*').eq('user_id', user.id).order('created_at', { ascending: false }).limit(50);
            el.notices.innerHTML = '';
            (ns || []).forEach((n) => {
                const d = document.createElement('div');
                d.className = 'p-3 rounded bg-black/10';
                d.textContent = `${n.type} · ${new Date(n.created_at).toLocaleString()}`;
                el.notices.appendChild(d);
            });
        }

        el.sendBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!user) {
                alert('请先登录');
                return;
            }
            const rid = el.to.value?.trim();
            const body = el.body.value?.trim();
            if (!rid || !body) {
                alert('请输入收件人与内容');
                return;
            }
            const { error } = await supabase.from('messages').insert({ sender_id: user.id, receiver_id: rid, body });
            if (error) alert(error.message);
            else {
                el.body.value = '';
                await load();
            }
        });

        await load();
    </script>
</Layout>
